{% load static %}
{% load i18n %}

<section class="loan-calculator card p-4" id="loan-calculator" aria-label="{% trans 'Home Loan Calculator' %}">
  <h3 class="mb-3">{% trans "Home Loan Calculator" %}</h3>
  <p class="text-muted mb-4">{% trans "Estimate your monthly payment and view an amortization schedule." %}</p>

  <div class="row g-3 align-items-end">
    <div class="col-md-6">
      <label for="lc-amount" class="form-label">{% trans "Loan Amount" %} (₺)</label>
      <div class="d-flex align-items-center gap-2">
        <input type="range" class="form-range flex-grow-1" id="lc-amount-range" min="10000" max="20000000" step="1000" value="500000" aria-label="{% trans 'Loan amount slider' %}">
        <input type="text" class="form-control" id="lc-amount" value="500000" inputmode="numeric" aria-describedby="lc-amount-help" autocomplete="off" spellcheck="false">
      </div>
      <div id="lc-amount-help" class="form-text">{% trans "Drag the slider or type a value." %}</div>
    </div>

    <div class="col-md-3">
      <label for="lc-term" class="form-label">{% trans "Term" %} ({% trans "months" %})</label>
      <div class="d-flex align-items-center gap-2">
        <input type="range" class="form-range flex-grow-1" id="lc-term-range" min="12" max="240" step="1" value="120" aria-label="{% trans 'Term slider' %}">
        <input type="text" class="form-control" id="lc-term" value="120" inputmode="numeric" autocomplete="off" spellcheck="false">
      </div>
    </div>

    <div class="col-md-3">
      <label for="lc-rate" class="form-label">{% trans "Interest Rate" %} (%)</label>
      <div class="input-group">
        <span class="input-group-text">%</span>
        <input type="text" class="form-control" id="lc-rate" value="3,25" inputmode="decimal" aria-describedby="lc-rate-help" autocomplete="off" spellcheck="false" placeholder="3,25">
      </div>
      <div id="lc-rate-help" class="form-text">{% trans "Annual nominal interest." %}</div>
    </div>

    <div class="col-12 d-flex justify-content-end mt-2">
      <button type="button" class="btn btn-primary" id="lc-calc-btn">{% trans "Calculate" %}</button>
    </div>
  </div>

  <hr class="my-4">

  <div id="lc-results" class="row g-3" aria-live="polite">
    <div class="col-md-4">
      <div class="p-3 border rounded-3 bg-light h-100">
        <div class="small text-muted">{% trans "Monthly Payment" %}</div>
        <div class="fs-4 fw-semibold" id="lc-monthly">—</div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="p-3 border rounded-3 bg-light h-100">
        <div class="small text-muted">{% trans "Total Interest" %}</div>
        <div class="fs-5" id="lc-total-interest">—</div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="p-3 border rounded-3 bg-light h-100">
        <div class="small text-muted">{% trans "Total Paid" %}</div>
        <div class="fs-5" id="lc-total-paid">—</div>
      </div>
    </div>
  </div>

  <div class="d-flex justify-content-between align-items-center mt-4">
    <h5 class="mb-0">{% trans "Amortization Schedule" %}</h5>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-secondary btn-sm" id="lc-toggle-table" type="button">{% trans "Show/Hide" %}</button>
      <button class="btn btn-outline-primary btn-sm" id="lc-download-csv" type="button">{% trans "Download CSV" %}</button>
    </div>
  </div>

  <div class="table-responsive mt-2" id="lc-table-wrap" hidden>
    <table class="table table-sm align-middle" id="lc-table">
      <thead>
        <tr>
          <th scope="col">#</th>
          <th scope="col" class="text-end">{% trans "Payment" %}</th>
          <th scope="col" class="text-end">{% trans "Principal" %}</th>
          <th scope="col" class="text-end">{% trans "Interest" %}</th>
          <th scope="col" class="text-end">{% trans "Balance" %}</th>
        </tr>
      </thead>
      <tbody id="lc-tbody"></tbody>
    </table>
  </div>

  <p class="mt-3 small text-muted">{% trans "This calculator provides estimates for illustration only and does not constitute a loan offer." %}</p>

  <style>
    /* Minimal polish scoped to this component */
    #loan-calculator .form-range { max-width: 220px; }
    #loan-calculator .gap-2 { gap: .5rem !important; }
    #loan-calculator .gap-3 { gap: 1rem !important; }
    #loan-calculator .fs-4 { font-size: 1.4rem; }
    #loan-calculator .fs-5 { font-size: 1.15rem; }
  </style>

  <script>
  (function(){
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    // i18n strings for JS-generated content
    const i18n = {
      payment: "{% trans 'Payment' %}",
      principal: "{% trans 'Principal' %}",
      interest: "{% trans 'Interest' %}",
      balance: "{% trans 'Balance' %}",
      csvName: "{% trans 'amortization' %}",
    };

    const el = {
      amount: $('#lc-amount'),
      amountRange: $('#lc-amount-range'),
      term: $('#lc-term'),
      termRange: $('#lc-term-range'),
      rate: $('#lc-rate'),
      calcBtn: $('#lc-calc-btn'),
      monthly: $('#lc-monthly'),
      totalInterest: $('#lc-total-interest'),
      totalPaid: $('#lc-total-paid'),
      toggleTable: $('#lc-toggle-table'),
      tableWrap: $('#lc-table-wrap'),
      tbody: $('#lc-tbody'),
      csvBtn: $('#lc-download-csv'),
    };

    // If the partial is not fully present, do nothing.
    if (Object.values(el).some(function(n){ return !n; })) return;

    const locale = "{{ LANGUAGE_CODE|default:'tr' }}" || document.documentElement.getAttribute('lang') || (navigator.language || 'tr-TR');
    const fmt = new Intl.NumberFormat(locale, { style: 'currency', currency: 'TRY', maximumFractionDigits: 2 });
    const fmtNum = new Intl.NumberFormat(locale, { maximumFractionDigits: 2 });

    function clamp(val, min, max) { return Math.min(Math.max(val, min), max); }

    // Parsing helpers tolerant to TR formatting
    const parseIntTR = (v, {min=0, max=Number.MAX_SAFE_INTEGER}={}) => {
      if (typeof v !== 'string') v = String(v ?? '');
      const digits = v.replace(/[^0-9]/g, '');
      let n = digits ? parseInt(digits, 10) : 0;
      if (!Number.isFinite(n)) n = 0;
      return clamp(n, min, max);
    };
    const parseRateTR = (v, {min=0, max=200}={}) => {
      if (typeof v !== 'string') v = String(v ?? '');
      // Accept "3,25" or "3.25"; remove thousands separators if any
      const cleaned = v.trim().replace(/\s/g,'').replace(/\.(?=\d{3}(?:\D|$))/g,'').replace(/,/g,'.');
      let n = Number(cleaned);
      if (!Number.isFinite(n)) n = 0;
      return clamp(n, min, max);
    };

    function syncPairInt(rangeEl, inputEl, min, max, step){
      function toStep(v){ return Math.round(v/step)*step; }
      rangeEl.addEventListener('input', () => { inputEl.value = rangeEl.value; });
      inputEl.addEventListener('input', () => {
        const v = parseIntTR(inputEl.value, {min:Number(min), max:Number(max)});
        inputEl.value = toStep(v);
        rangeEl.value = inputEl.value;
      });
      rangeEl.addEventListener('change', () => { inputEl.dispatchEvent(new Event('input')); });
    }

    // Set min/max on text inputs for info; enforce via parser
    el.amount.setAttribute('data-min','10000');
    el.amount.setAttribute('data-max','20000000');
    el.term.setAttribute('data-min','12');
    el.term.setAttribute('data-max','240');

    syncPairInt(el.amountRange, el.amount, 10000, 20000000, 1000);
    syncPairInt(el.termRange, el.term, 12, 240, 1);

    function calculateSchedule(P, annualRatePct, nMonths) {
      const rMonthly = (annualRatePct/100)/12; // monthly nominal
      const schedule = [];
      let balance = P;
      let M;
      if (rMonthly > 0) {
        const pow = Math.pow(1 + rMonthly, nMonths);
        M = P * rMonthly * pow / (pow - 1);
      } else {
        M = P / nMonths;
      }
      for (let i=1; i<=nMonths; i++) {
        const interest = rMonthly > 0 ? balance * rMonthly : 0;
        let principal = M - interest;
        if (i === nMonths) { // avoid residual rounding
          principal = balance;
        }
        balance = Math.max(0, balance - principal);
        schedule.push({
          idx: i,
          payment: M,
          principal: principal,
          interest: interest,
          balance: balance,
        });
      }
      const totals = schedule.reduce((acc, r) => {
        acc.paid += r.payment; acc.interest += r.interest; return acc; }, { paid: 0, interest: 0 });
      return { schedule, monthly: M, totalInterest: totals.interest, totalPaid: totals.paid };
    }

    function renderResults(res) {
      el.monthly.textContent = fmt.format(res.monthly);
      el.totalInterest.textContent = fmt.format(res.totalInterest);
      el.totalPaid.textContent = fmt.format(res.totalPaid);
    }

    function renderTable(schedule) {
      el.tbody.innerHTML = '';
      const frag = document.createDocumentFragment();
      for (const row of schedule) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.idx}</td>
          <td class="text-end">${fmt.format(row.payment)}</td>
          <td class="text-end">${fmt.format(row.principal)}</td>
          <td class="text-end">${fmt.format(row.interest)}</td>
          <td class="text-end">${fmt.format(row.balance)}</td>
        `;
        frag.appendChild(tr);
      }
      el.tbody.appendChild(frag);
    }

    function toCSV(schedule) {
      const header = ['#', i18n.payment, i18n.principal, i18n.interest, i18n.balance];
      const rows = schedule.map(r => [r.idx, fmtNum.format(r.payment), fmtNum.format(r.principal), fmtNum.format(r.interest), fmtNum.format(r.balance)]);
      const all = [header, ...rows].map(r => r.join(',')).join('\n');
      return new Blob([all], { type: 'text/csv;charset=utf-8;' });
    }

    function runCalc() {
      const P = parseIntTR(el.amount.value, {min:10000, max:20000000});
      const n = parseIntTR(el.term.value, {min:12, max:240});
      const rate = parseRateTR(el.rate.value, {min:0, max:200});
      el.amount.value = P; el.term.value = n; el.rate.value = fmtNum.format(rate);
      const res = calculateSchedule(P, rate, n);
      renderResults(res);
      renderTable(res.schedule);
      return res;
    }

    el.calcBtn.addEventListener('click', runCalc);
    el.toggleTable.addEventListener('click', () => { el.tableWrap.hidden = !el.tableWrap.hidden; });
    el.csvBtn.addEventListener('click', () => {
      const res = runCalc();
      const blob = toCSV(res.schedule);
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = (i18n.csvName || 'amortization') + '.csv';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    });

    // Initial calc
    runCalc();
  })();
  </script>
</section>
